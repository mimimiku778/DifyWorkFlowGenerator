# Gemini CLI でのDifyワークフロー生成

Gemini CLI（私）がユーザーからワークフローの要件を聞いて、直接DifyワークフローのYAMLファイルを生成します。

## 使用方法

Gemini CLIに以下のように話しかけてください：

「Difyワークフローを生成してください。要件は以下の通りです：
- 目的：[ワークフローの目的]
- 処理フロー：
  1. [ステップ1の説明]
  2. [ステップ2の説明]
  3. [ステップ3の説明]」

## 生成アルゴリズム

Gemini CLIは以下の手順でワークフローを生成します：

### 1. 要件分析
- ユーザーの要件を解析
- 必要なノードタイプを特定
- 処理フローを設計

### 2. ノード生成
以下のノードタイプをサポート：

**基本ノード**
- 開始ノード（start）：ユーザー入力受付
- LLMノード（llm）：テキスト生成・処理
- 終了ノード（end）：結果出力

**分岐・制御ノード**
- 質問分類器（question-classifier）：入力の自動分類
- IF/ELSEノード（if-else）：条件分岐
- Variable Aggregator（variable-aggregator）：変数統合

**データ処理ノード**
- 知識検索（knowledge-retrieval）：データセット検索
- HTTPリクエスト（http-request）：API連携
- JSONパース（json-process）：JSON処理
- コード実行（code）：Python処理

**テキスト・メディア処理**
- Document Extractor（document-extractor）：ファイル抽出
- Template Transform（template-transform）：テンプレート変換
- Parameter Extractor（parameter-extractor）：パラメータ抽出
- YouTubeトランスクリプト（transcript）：動画字幕取得
- JinaReader（jina）：ウェブページ抽出
- TavilySearch（tavily）：ウェブ検索

### 3. エッジ接続生成
- ノード間の接続を自動設定
- 分岐ノードの適切なハンドル設定
- 並列処理パスの構築

### 4. 設定値生成
- ユニークなノードID生成（1700000000000番台）
- モデル設定（OpenAI GPT-4o）
- 変数セレクター設定

### 5. YAML出力
Difyに直接インポート可能な形式で出力：
```yaml
app:
  mode: workflow
  name: [ワークフロー名]
  version: 0.1.3

workflow:
  graph:
    edges: [エッジ定義]
    nodes: [ノード定義]
```

### 6. 品質チェックと修正サイクル

生成後、以下のチェックと修正を自動実行：

1. **品質チェック**
   - 生成されたYAMLがworkflow_generator_prompt.ymlのルールに従っているか確認
   - 必須ノードの存在確認
   - エッジ接続の整合性確認
   - 変数参照の妥当性確認

2. **問題検出時の処理**
   - 検出された問題を明確化
   - 問題を修正するための指示を追加
   - ワークフローを再生成

3. **修正サイクル**
   - 問題が解消されるまで生成→チェック→修正を繰り返す
   - 最大3回まで自動修正を試行
   - 最終的に品質基準を満たしたYAMLを出力

## 例：料理レシピ検索ワークフロー

**要件**：
```
目的：料理のレシピを調べて記事にする
1. 料理名をユーザーから入力
2. インターネットで検索して3つのURLを取得
3. 各URLからレシピ情報を並列取得
4. 情報を統合して記事形式で出力
```

**生成されるノード構成**：
1. 開始ノード（料理名入力）
2. TavilySearchノード（レシピ検索）
3. Parameter Extractorノード（URL抽出）
4. 3つのJinaReaderノード（並列情報取得）
5. Variable Aggregatorノード（情報統合）
6. LLMノード（記事生成）
7. 終了ノード（結果出力）

## 制約・注意事項

- コードノードではboolean型使用不可（number型の0/1使用）
- ノードIDは1700000000000〜1799999999999の範囲
- 知識検索にはdataset_idが必要
- 一部ノード（イテレーション、変数代入等）は未対応

## サポート

Gemini CLIに直接質問してください：
- 「このワークフローを修正してください」
- 「別のノードタイプを使いたいです」
- 「エラーが発生しました」